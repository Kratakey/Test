name: Selenide Java CI #

on: [ push, workflow_dispatch ]

permissions:
  contents: write
  pages: write
  id-token: write

env:
  JAVA_VERSION: '17'
  BROWSER_VERSION: '128.0'
  THREADS: '8'

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      selenium:
        image: selenoid/chrome:128.0
        ports:
          - 4444:4444
        options: >-
          --shm-size="2g"
          --health-cmd="curl -f http://localhost:4444/status || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Wait for Selenium to be ready
        run: |
          for i in {1..30}; do
            curl -sf http://localhost:4444/status && break
            echo "Waiting for Selenium... ($i/30)"
            sleep 2
          done

      - name: Build and run tests
        run: |
          ./gradlew clean test \
            -Denvironment=local_chrome \
            -DbrowserVersion=${{ env.BROWSER_VERSION }} \
            -Dthreads=${{ env.THREADS }} \
            --no-daemon

      - name: Get Allure history
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate Allure report
        uses: simple-elf/allure-report-action@master
        if: always()
        id: allure-report
        with:
          allure_results: build/allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history
          keep_reports: 20

      - name: Deploy report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            build/reports/
            build/allure-results/
          retention-days: 7

      - name: Calculate REPORT_NUM
        run: |
          REPORT_NUM=$(ls -d allure-history/[0-9]*/ 2>/dev/null | sed 's|allure-history/||;s|/||' | sort -n | tail -1)
          echo "REPORT_NUM=$REPORT_NUM"
          echo "REPORT_NUM=$REPORT_NUM" >> $GITHUB_ENV

      - name: Send email
        if: ${{ always() && (!inputs.report_on_failure_only || failure()) }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[${{ job.status }}] ${{ inputs.job_label }} — ${{ github.repository }}"
          to: qatestkra@gmail.com
          from: "GitHub CI <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            ${{ inputs.job_label }} finished with status: ${{ job.status }}
            See report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_NUM }}

      - name: Send Telegram notification
        if: ${{ always() && (!inputs.report_on_failure_only || failure()) }}
        run: |
            REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            SUMMARY="allure-report/widgets/summary.json"
            PASSED=$(jq  '.statistic.passed'  $SUMMARY)
            FAILED=$(jq  '.statistic.failed'  $SUMMARY)
            BROKEN=$(jq  '.statistic.broken'  $SUMMARY)
            SKIPPED=$(jq '.statistic.skipped' $SUMMARY)
            TOTAL=$(jq   '.statistic.total'   $SUMMARY)
            EMOJI=$([ "$FAILED" = "0" ] && [ "$BROKEN" = "0" ] && echo "✅" || echo "❌")
            
            sudo apt-get install -y librsvg2-bin
            
            python3 - $PASSED $FAILED $BROKEN $SKIPPED $TOTAL << 'EOF'
            import math, sys

            passed, failed, broken, skipped, total = [int(x) for x in sys.argv[1:6]]

            def donut_path(start_angle, end_angle, r_outer, r_inner, cx, cy):
             if end_angle - start_angle >= 360:
              end_angle = start_angle + 359.999
            start_rad = math.radians(start_angle - 90)
            end_rad   = math.radians(end_angle   - 90)
            x1 = cx + r_outer * math.cos(start_rad)
            y1 = cy + r_outer * math.sin(start_rad)
            x2 = cx + r_outer * math.cos(end_rad)
            y2 = cy + r_outer * math.sin(end_rad)
            x3 = cx + r_inner * math.cos(end_rad)
            y3 = cy + r_inner * math.sin(end_rad)
            x4 = cx + r_inner * math.cos(start_rad)
            y4 = cy + r_inner * math.sin(start_rad)
            large = 1 if (end_angle - start_angle) > 180 else 0
            return (f"M {x1:.2f} {y1:.2f} "
            f"A {r_outer} {r_outer} 0 {large} 1 {x2:.2f} {y2:.2f} "
            f"L {x3:.2f} {y3:.2f} "
            f"A {r_inner} {r_inner} 0 {large} 0 {x4:.2f} {y4:.2f} Z")

            cx, cy, ro, ri = 100, 100, 80, 50
            segments = [
            (passed,  "#97cc64"),
            (failed,  "#fd5a3e"),
            (broken,  "#ffd050"),
            (skipped, "#aaa"),
              ]
    
          paths = []
          angle = 0
          for count, color in segments:
            if total > 0 and count > 0:
              sweep = 360 * count / total
              paths.append(f'<path d="{donut_path(angle, angle+sweep, ro, ri, cx, cy)}" fill="{color}"/>')
              angle += sweep
          
          if total == 0:
            paths.append(f'<circle cx="{cx}" cy="{cy}" r="{ro}" fill="#eee"/>'
            f'<circle cx="{cx}" cy="{cy}" r="{ri}" fill="white"/>')
          
          svg = f"""<svg xmlns="http://www.w3.org/2000/svg" width="400" height="220" style="background:#1a1a2e">
          <g>{"".join(paths)}</g>
          <text x="{cx}" y="{cy-10}" text-anchor="middle" font-size="22" font-weight="bold" fill="white">{total}</text>
          <text x="{cx}" y="{cy+14}" text-anchor="middle" font-size="11" fill="#aaa">total</text>
          <rect x="210" y="30"  width="14" height="14" fill="#97cc64"/>
          <text x="230" y="42"  font-size="14" fill="white">Passed: { passed }</text>
          <rect x="210" y="60"  width="14" height="14" fill="#fd5a3e"/>
          <text x="230" y="72"  font-size="14" fill="white">Failed: { failed }</text>
          <rect x="210" y="90"  width="14" height="14" fill="#ffd050"/>
          <text x="230" y="102" font-size="14" fill="white">Broken: { broken }</text>
          <rect x="210" y="120" width="14" height="14" fill="#aaa"/>
          <text x="230" y="132" font-size="14" fill="white">Skipped: { skipped }</text>
          </svg>"""
          
          with open("/tmp/donut.svg", "w") as f:
            f.write(svg)
          print("SVG generated OK")
          EOF
          
          rsvg-convert /tmp/donut.svg -o /tmp/donut.png
          
          TEXT="${EMOJI} *${{ inputs.job_label }} — ${REPO_NAME}*
          https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ env.REPORT_NUM }}"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
          -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -F parse_mode="Markdown" \
          -F caption="$TEXT" \
          -F photo="@/tmp/donut.png"